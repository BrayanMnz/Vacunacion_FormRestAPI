/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package ProyectoVacunacion.ClienteREST;

import io.javalin.Javalin;

import java.time.LocalDate;
import java.time.Month;
import java.time.Period;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import ProyectoVacunacion.ClienteREST.Controllers.*;
import ProyectoVacunacion.ClienteREST.Models.Persona;
import ProyectoVacunacion.ClienteREST.Services.PersonaServices;
import ProyectoVacunacion.ClienteREST.Services.MailService;
import ProyectoVacunacion.ClienteREST.util.*;
import io.javalin.http.staticfiles.Location;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;


public class Main {

    private static PersonaServices serviciosPersona = PersonaServices.getInstancia();
    private static String modoConexion = "";

    public static void main(String[] args) {

        // Creando la instancia del servidor.
        Javalin app = Javalin.create(config -> {
            config.addStaticFiles("/publico"); // desde la carpeta de resources
            // config.addStaticFiles("src/main/resources/publico", Location.EXTERNAL);
            config.enableCorsForAllOrigins();
        });

        app.start(8000);

        ScheduledExecutorService executorService;
        executorService = Executors.newSingleThreadScheduledExecutor();
        executorService.scheduleAtFixedRate(Main::run, 0, 100, TimeUnit.SECONDS);

        ScheduledExecutorService executorService1;
        executorService1 = Executors.newSingleThreadScheduledExecutor();
        executorService1.scheduleAtFixedRate(Main::sendDigitalCard, 0, 60, TimeUnit.SECONDS);

        // new MainController(app).aplicarRutas();

    }

    private static void run() {
        System.out.println("Running: " + new java.util.Date());

        List<Persona> personas = serviciosPersona.PersonasForSurvey();

        for (Persona persona : personas) {
            try {
                MailService.sendMail(persona,true);
                persona.setEncuestado(true);
                serviciosPersona.editar(persona);
            } catch (Exception e) {
                System.out.println("Mail not sent: "+e.getMessage());

            }
            
        }
    }


    private static void sendDigitalCard() {
        System.out.println("Running: " + new java.util.Date());

        List<Persona> personas = serviciosPersona.PersonasForSurvey();

        for (Persona persona : personas) {
            try {
                MailService.sendMail(persona,false);
            } catch (Exception e) {
                System.out.println("Mail not sent: "+e.getMessage());

            }
            
        }
    }







    public static String getModoConexion() {
        return modoConexion;
    }
}
